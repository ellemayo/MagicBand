#include <Arduino.h>
#include <DebugConfig.h>
#include <IRControl.h>
#include <LEDControl.h>
#include <ServoControl.h>
#include <AudioControlDFPlayer.h>

// Diagnostic test program for MagiQuest hardware
// This runs a series of tests to verify all components are working

void setup() {
  Serial.begin(115200);
  delay(2000);  // Give time to open Serial Monitor
  
  Serial.println("\n\n");
  Serial.println("========================================");
  Serial.println("  MagiQuest Hardware Diagnostic Tool");
  Serial.println("========================================");
  Serial.println();
  
  // Test 1: IR Receiver
  Serial.println("TEST 1: IR Receiver (GPIO14)");
  Serial.println("----------------------------------------");
  setup_ir();
  Serial.println("IR receiver initialized on GPIO14");
  Serial.println("Point a TV remote at the sensor and press buttons...");
  Serial.println("Waiting 10 seconds for IR signals...");
  
  unsigned long start = millis();
  int ir_detections = 0;
  while (millis() - start < 10000) {
    uint32_t wand_id = loop_ir();
    if (wand_id != 0) {
      ir_detections++;
      Serial.print("  ✓ IR signal detected! Wand ID: 0x");
      Serial.println(wand_id, HEX);
    }
    delay(100);
  }
  
  if (ir_detections > 0) {
    Serial.println("✓ IR Receiver: PASS");
  } else {
    Serial.println("✗ IR Receiver: FAIL - No signals detected");
    Serial.println("  Check: GPIO14 connection, IR receiver power, try TV remote");
  }
  Serial.println();
  
  // Test 2: LEDs
  Serial.println("TEST 2: LED Strip (GPIO3)");
  Serial.println("----------------------------------------");
  setup_leds();
  Serial.println("Testing colors...");
  
  Serial.println("  Red...");
  set_color(CRGB::Red);
  delay(1000);
  
  Serial.println("  Green...");
  set_color(CRGB::Green);
  delay(1000);
  
  Serial.println("  Blue...");
  set_color(CRGB::Blue);
  delay(1000);
  
  Serial.println("  Off...");
  set_color(CRGB::Black);
  
  Serial.println("✓ LED Strip: If you saw colors, PASS");
  Serial.println("  If not: Check GPIO3 connection, LED power, data line");
  Serial.println();
  
  // Test 3: Servo
  Serial.println("TEST 3: Servo Motor (GPIO18)");
  Serial.println("----------------------------------------");
  setup_servo();
  Serial.println("Testing servo movement...");
  
  Serial.println("  Moving to position 1...");
  toggle_lid();
  delay(2000);
  
  Serial.println("  Moving to position 2...");
  toggle_lid();
  delay(2000);
  
  Serial.println("✓ Servo: If you saw movement, PASS");
  Serial.println("  If not: Check GPIO18 connection, servo power");
  Serial.println();
  
  // Test 4: DFPlayer Mini
  Serial.println("TEST 4: DFPlayer Mini (GPIO16/17)");
  Serial.println("----------------------------------------");
  
  if (!setup_audio_dfplayer()) {
    Serial.println("✗ DFPlayer: FAIL - Initialization failed");
    Serial.println("  Check:");
    Serial.println("    - GPIO16 (ESP32) → TX (DFPlayer)");
    Serial.println("    - GPIO17 (ESP32) → RX (DFPlayer)");
    Serial.println("    - VCC/GND connections");
    Serial.println("    - SD card inserted and formatted FAT32");
    Serial.println("    - DFPlayer module not damaged");
  } else {
    Serial.println("✓ DFPlayer initialized");
    
    int file_count = get_file_count();
    Serial.print("  Files on SD card: ");
    Serial.println(file_count);
    
    if (file_count <= 0) {
      Serial.println("✗ SD Card: FAIL - No files detected or read error");
      Serial.println("  Check:");
      Serial.println("    - SD card is inserted");
      Serial.println("    - SD card is FAT32 format");
      Serial.println("    - Files are named 0001.wav, 0002.wav, etc.");
      Serial.println("    - Files are in root directory");
      Serial.println("    - Try a different SD card");
    } else {
      Serial.println("✓ SD Card: PASS");
      
      // Test audio playback
      Serial.println("  Testing audio playback (file 0001.wav)...");
      set_volume(25);
      
      if (play_sound_file(1)) {
        Serial.println("✓ Audio playback command sent");
        Serial.println("  Listen for sound from speaker");
        delay(3000);
      } else {
        Serial.println("✗ Audio playback failed");
      }
    }
  }
  Serial.println();
  
  // Test 5: Power Supply Check
  Serial.println("TEST 5: Power Supply");
  Serial.println("----------------------------------------");
  Serial.print("ESP32 Supply Voltage: ");
  
  // Read internal hall sensor as proxy for power
  Serial.println("Check with multimeter:");
  Serial.println("  ESP32 should have stable 3.3V or 5V");
  Serial.println("  DFPlayer should have 3.3-5V");
  Serial.println("  Servo should have 5V");
  Serial.println("  LEDs should have 5V");
  Serial.println();
  
  // Summary
  Serial.println("========================================");
  Serial.println("  Diagnostic Complete");
  Serial.println("========================================");
  Serial.println();
  Serial.println("Component Status Summary:");
  Serial.println("  IR Receiver : Check serial output above");
  Serial.println("  LED Strip   : Visual check required");
  Serial.println("  Servo Motor : Visual check required");
  Serial.println("  DFPlayer    : Check serial output above");
  Serial.println();
  Serial.println("If any component failed:");
  Serial.println("  1. Check all wiring connections");
  Serial.println("  2. Verify power supply (use multimeter)");
  Serial.println("  3. Test component individually");
  Serial.println("  4. Replace damaged components");
  Serial.println();
  Serial.println("Short circuit damage is most likely to affect:");
  Serial.println("  - ESP32 GPIO pins (may be permanently damaged)");
  Serial.println("  - DFPlayer Mini module");
  Serial.println("  - IR receiver sensor");
  Serial.println();
}

void loop() {
  // Continuous IR monitoring
  static unsigned long last_report = 0;
  
  if (millis() - last_report > 5000) {
    Serial.println("Monitoring IR signals... (point wand or remote)");
    last_report = millis();
  }
  
  uint32_t wand_id = loop_ir();
  if (wand_id != 0) {
    Serial.print("IR DETECTED: Wand ID 0x");
    Serial.print(wand_id, HEX);
    Serial.print(" (");
    Serial.print(wand_id);
    Serial.println(")");
    
    // Flash LED on detection
    set_color(CRGB::Green);
    delay(100);
    set_color(CRGB::Black);
  }
  
  delay(50);
}
